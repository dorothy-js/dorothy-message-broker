/* @pollon/message-broker - v1.0.0
* https://github.com/pollon-js/message-broker#readme
* 2020 Francesco Lasaracina. Licensed ISC */
System.register([],(function(t){"use strict";return{execute:function(){function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function n(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&s(t,e)}function o(t){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function s(t,e){return(s=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function u(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}var a=function(){function t(r,n){e(this,t),this.method=r,this.context=n,this.disposeStrategy=function(){},this.disposed=!1}return n(t,[{key:"setDisposeStrategy",value:function(t){this.disposeStrategy="function"==typeof t?t:function(){}}},{key:"dispose",value:function(){this.disposeStrategy(),this.disposed=!0}}]),t}(),c=function(){function t(){e(this,t),this.stack=[],this.once=[]}return n(t,[{key:"add",value:function(t,e,r){var n,i=this;n=new a(t,e);for(var o=0;o<this.stack.length;o++)if(t===this.stack[o].method)return;return this.stack.unshift(n),r&&this.once.unshift(n),n.setDisposeStrategy((function(){for(var e=0;e<i.stack.length;e++)t===i.stack[e].method&&i.stack.splice(e,1);for(var r=0;r<i.once.length;r++)t===i.once[r].method&&i.once.splice(r,1)})),n}},{key:"remove",value:function(t){var e,r;e=this.stack.length,r=this.once.length;for(var n=0;n<e;n++)t===this.stack[n].method&&this.stack.splice(n,1);for(var i=0;i<r;i++)t===this.once[i].method&&this.once.splice(i,1)}},{key:"fire",value:function(){for(var t,e=this,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return t=this.stack.slice().reverse().map((function(t){return Promise.resolve(!0).then((function(){if(e.stack.includes(t)){for(var r=t.method.apply(t.context,n),i=0;i<e.once.length;i++)t.method===e.once[i].method&&t.dispose();return r}}))})),Promise.all(t)}}]),t}(),l=t("Publisher",function(){function t(r){e(this,t),r=Array.isArray(r)?r:[],this.publications={};var n=!0,i=!1,o=void 0;try{for(var s,u=r[Symbol.iterator]();!(n=(s=u.next()).done);n=!0){var a=s.value;if(!a)throw"Pollon: [broker-provider] Cannot define a publisher with an falsy/undefined name";this.publications[a]=new c}}catch(t){i=!0,o=t}finally{try{n||null==u.return||u.return()}finally{if(i)throw o}}}return n(t,[{key:"getDelegate",value:function(t){return t in this.publications?this.publications[t]:null}},{key:"fire",value:function(t,e,r){return r=r||this,this.publications[t]?this.publications[t].fire(r,e):Promise.resolve(!0)}}]),t}());function h(t){return"object"==Object.prototype.toString.call(t).match(/^\[object\s(.*)\]$/)[1].toLowerCase()}t("Subscriber",(function t(r){e(this,t),this.subscriptions=h(r)?r:{}}));var f=function(t,e){return Array.prototype.indexOf.call(t,e)},p=(t("Broker",function(){function t(){e(this,t),this.publishers=[],this.handlers={},this.fireDelegates={}}return n(t,[{key:"add",value:function(t){t.subscriptions&&this.addSubscriber(t),t.publications&&this.addPublisher(t)}},{key:"remove",value:function(t){t.subscriptions&&this.removeSubscriber(t),t.publications&&this.removePublisher(t)}},{key:"addSubscriber",value:function(t){var e,r,n;if(t.subscriptions)for(e in t.subscriptions)r=t.subscriptions[e],e in this.handlers||(this.handlers[e]=new c),(n=h(r)?r:{method:r,context:null,once:!1}).context=r.context||t,n.once=!!r.once||!1,this.handlers[e].add(n.method,n.context,n.once)}},{key:"removeSubscriber",value:function(t){var e,r,n;if(t.subscriptions)for(e in t.subscriptions)r=t.subscriptions[e],e in this.handlers&&(n=h(r)?r:{method:r},this.handlers[e].remove(n.method))}},{key:"addPublisher",value:function(t){var e,r;if(t.publications){if((e=f(this.publishers,t))>-1)return e;for(r in this.publishers[this.publishers.length]=t,t.publications)t.publications[r].add(this.getFireDelegate(r),null,!1);return e}}},{key:"removePublisher",value:function(t){var e,r;if(t.publications){if(-1==(e=f(this.publishers,t)))return e;for(r in this.publishers.splice(e,1),t.publications)t.publications[r].remove(this.getFireDelegate(r));return e}}},{key:"getFireDelegate",value:function(t){var e=this;return this.fireDelegates[t]?this.fireDelegates[t]:(this.fireDelegates[t]=function(t,r){var n=e.handlers[r.name]?e.handlers[r.name]:null;if(n)return n.fire(t,r)},this.fireDelegates[t])}}]),t}()),t("EventDelegate",function(t){function r(){return e(this,r),u(this,o(r).call(this))}return i(r,t),n(r,[{key:"fire",value:function(){for(var t,e,r=this,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return t=i[1],e=this.stack.slice().reverse().map((function(e){return Promise.resolve(!0).then((function(){if((!t.isEventPropagationStopped||!t.isEventPropagationStopped())&&r.stack.includes(e)){for(var n=e.method.apply(e.context,i),o=0;o<r.once.length;o++)e.method===r.once[o].method&&e.dispose();return n}}))})),Promise.all(e)}}]),r}(c))),v=function t(r){e(this,t),this.name=r},d=(t("Event",function(t){function r(t,n){var i;return e(this,r),(i=u(this,o(r).call(this,t))).propagationStopped=!1,i.args=n,i}return i(r,t),n(r,[{key:"stopEventPropagation",value:function(){this.propagationStopped=!0}},{key:"isEventPropagationStopped",value:function(){return!!this.propagationStopped}}]),r}(v)),t("EventPublisher",function(t){function r(t){var n;e(this,r),n=u(this,o(r).call(this,[])),t=Array.isArray(t)?t:[],n.publications={};var i=!0,s=!1,a=void 0;try{for(var c,l=t[Symbol.iterator]();!(i=(c=l.next()).done);i=!0){var h=c.value;n.publications[h]=new p}}catch(t){s=!0,a=t}finally{try{i||null==l.return||l.return()}finally{if(s)throw a}}return n}return i(r,t),n(r,[{key:"fire",value:function(t,e,r){return r=r||this,this.publications[t]?this.publications[t].fire(r,e):Promise.resolve(!0)}}]),r}(l)),t("Property",function(t){function r(t){var n;return e(this,r),(n=u(this,o(r).call(this,t))).property=null,n}return i(r,t),n(r,[{key:"exists",value:function(){return null!==this.property}}]),r}(v)));t("PropertyNeeder",function(t){function r(t){return e(this,r),u(this,o(r).call(this,t))}return i(r,t),n(r,[{key:"getProperty",value:function(t){var e=this.getDelegate(t);if(!e||!e.stack.length)throw"Pollon: [broker-provider] provider not found for the property ".concat(t);var r=new d(t);return this.fire(t,r,this).catch((function(e){throw"Pollon: [broker-provider] error ".concat(e," when looking for provider for the property ").concat(t)})).then((function(e){if(!r.exists())throw"Pollon: [broker-provider] provider not found for the property ".concat(t);return r.property}))}}]),r}(l))}}}));
